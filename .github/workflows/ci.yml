name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: uv sync --frozen --dev
      - run: uv run ruff check src/ api/ tests/
      - run: uv run ruff format --check src/ api/ tests/

  test:
    runs-on: ubuntu-latest
    needs: lint
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
    env:
      DATABASE_URL: "sqlite+aiosqlite:///test.db"
      REDIS_URL: "redis://localhost:6379/0"
      TELEGRAM_BOT_TOKEN: "test-token"
      TELEGRAM_WEBHOOK_URL: "https://test.example.com/webhook"
      ANTHROPIC_API_KEY: "test-key"
      OPENAI_API_KEY: "test-key"
      GOOGLE_AI_API_KEY: "test-key"
      APP_ENV: "test"
      LOG_LEVEL: "WARNING"
      SUPABASE_URL: "https://test.supabase.co"
      SUPABASE_KEY: "test-key"
      SUPABASE_SERVICE_KEY: "test-key"
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: uv sync --frozen --dev
      - run: uv run pytest tests/ -x --tb=short -q
      - run: uv run pytest tests/ --cov=src --cov-report=xml
      - uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

  docker:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: finance-bot:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    runs-on: ubuntu-latest
    needs: [test, docker]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Railway
        uses: bervProject/railway-deploy@main
        with:
          railway_token: ${{ secrets.RAILWAY_TOKEN }}
          service: finance-bot
